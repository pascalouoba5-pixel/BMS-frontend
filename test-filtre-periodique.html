<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Filtre P√©riodique - Suivi des R√©sultats</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .role-button {
            background-color: #6c757d;
        }
        .role-button.active {
            background-color: #28a745;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .filter-demo {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Filtre P√©riodique - Suivi des R√©sultats</h1>
        
        <div class="test-section info">
            <h3>üìã Nouvelles Fonctionnalit√©s</h3>
            <ul>
                <li><strong>Filtre p√©riodique personnalisable</strong> : 7j, 30j, 90j, p√©riode personnalis√©e</li>
                <li><strong>Permissions restrictives</strong> : Seuls S.Admin et CMA peuvent modifier</li>
                <li><strong>Indicateur visuel</strong> : Mode √©dition/consultation</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîß Test des Permissions</h3>
            <p>S√©lectionnez un r√¥le pour tester les permissions :</p>
            <div>
                <button class="role-button" onclick="setRole('s_admin')">Super Admin</button>
                <button class="role-button" onclick="setRole('cma')">CMA</button>
                <button class="role-button" onclick="setRole('admin')">Admin</button>
                <button class="role-button" onclick="setRole('cmt')">CMT</button>
                <button class="role-button" onclick="setRole('charge_ajout_offre')">Charg√© d'offre</button>
            </div>
            <div id="permission-status" class="filter-demo">
                <strong>R√¥le actuel :</strong> <span id="current-role">Aucun</span><br>
                <strong>Permissions d'√©dition :</strong> <span id="edit-permission">Non</span>
            </div>
        </div>

        <div class="test-section">
            <h3>üìÖ Test du Filtre P√©riodique</h3>
            <p>Simulation du filtre p√©riodique avec des donn√©es de test :</p>
            
            <div class="filter-demo">
                <strong>P√©riode s√©lectionn√©e :</strong>
                <select id="period-select" onchange="updatePeriodFilter()">
                    <option value="tous">Toutes les p√©riodes</option>
                    <option value="7j">7 derniers jours</option>
                    <option value="30j">30 derniers jours</option>
                    <option value="90j">90 derniers jours</option>
                    <option value="personnalise">P√©riode personnalis√©e</option>
                </select>
            </div>

            <div id="custom-date-inputs" class="filter-demo" style="display: none;">
                <div class="date-range">
                    <label>Date de d√©but :</label>
                    <input type="date" id="start-date" onchange="updateCustomPeriod()">
                    <label>Date de fin :</label>
                    <input type="date" id="end-date" onchange="updateCustomPeriod()">
                </div>
                <div id="custom-period-display"></div>
            </div>

            <div id="filter-results" class="filter-demo">
                <strong>R√©sultats du filtre :</strong>
                <div id="filtered-count"></div>
                <div id="filtered-offres"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>üîß Actions de Test</h3>
            <button onclick="loadTestData()">Charger les donn√©es de test</button>
            <button onclick="testPeriodFilter()">Tester le filtre p√©riodique</button>
            <button onclick="clearData()">Effacer les donn√©es</button>
        </div>

        <div id="results" class="test-section">
            <h3>üìä R√©sultats du Test</h3>
            <div id="stats-display"></div>
        </div>

        <div class="test-section info">
            <h3>‚úÖ Instructions de Test</h3>
            <ol>
                <li>Chargez les donn√©es de test</li>
                <li>Testez diff√©rents r√¥les pour voir les permissions</li>
                <li>Testez le filtre p√©riodique avec diff√©rentes p√©riodes</li>
                <li>Allez sur <a href="http://localhost:3000/suivi-resultats" target="_blank">http://localhost:3000/suivi-resultats</a></li>
                <li>V√©rifiez que seuls S.Admin et CMA voient les boutons "Modifier"</li>
                <li>Testez le filtre p√©riodique dans l'application</li>
            </ol>
        </div>
    </div>

    <script>
        let currentRole = '';
        let testOffres = [];

        // Donn√©es de test avec diff√©rentes dates
        const testOffresData = [
            {
                id: 1,
                intituleOffre: "Offre r√©cente (2 jours)",
                dateDepot: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                resultatOffre: "Gagn√©e"
            },
            {
                id: 2,
                intituleOffre: "Offre ancienne (45 jours)",
                dateDepot: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                resultatOffre: "Perdue"
            },
            {
                id: 3,
                intituleOffre: "Offre tr√®s ancienne (120 jours)",
                dateDepot: new Date(Date.now() - 120 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                resultatOffre: "En cours"
            },
            {
                id: 4,
                intituleOffre: "Offre moyenne (15 jours)",
                dateDepot: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                resultatOffre: "Gagn√©e"
            }
        ];

        function setRole(role) {
            currentRole = role;
            
            // Mettre √† jour l'affichage des boutons
            document.querySelectorAll('.role-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mettre √† jour le statut des permissions
            updatePermissionStatus();
            
            // Sauvegarder dans localStorage
            localStorage.setItem('user', JSON.stringify({
                id: '1',
                email: 'test@test.com',
                nom: 'Test',
                prenom: 'Utilisateur',
                role: role
            }));
        }

        function updatePermissionStatus() {
            const canEdit = currentRole === 's_admin' || currentRole === 'cma';
            document.getElementById('current-role').textContent = currentRole || 'Aucun';
            document.getElementById('edit-permission').textContent = canEdit ? 'Oui' : 'Non';
            document.getElementById('edit-permission').style.color = canEdit ? 'green' : 'red';
        }

        function updatePeriodFilter() {
            const period = document.getElementById('period-select').value;
            const customInputs = document.getElementById('custom-date-inputs');
            
            if (period === 'personnalise') {
                customInputs.style.display = 'block';
            } else {
                customInputs.style.display = 'none';
                testPeriodFilter();
            }
        }

        function updateCustomPeriod() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate) {
                document.getElementById('custom-period-display').innerHTML = 
                    `<strong>P√©riode s√©lectionn√©e :</strong> ${startDate} √† ${endDate}`;
                testPeriodFilter();
            }
        }

        function testPeriodFilter() {
            const period = document.getElementById('period-select').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            let filteredOffres = testOffres;
            
            if (period !== 'tous') {
                const today = new Date();
                
                filteredOffres = testOffres.filter(offre => {
                    if (!offre.dateDepot) return false;
                    
                    const offreDate = new Date(offre.dateDepot);
                    
                    switch (period) {
                        case '7j':
                            const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return offreDate >= sevenDaysAgo;
                        case '30j':
                            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                            return offreDate >= thirtyDaysAgo;
                        case '90j':
                            const ninetyDaysAgo = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                            return offreDate >= ninetyDaysAgo;
                        case 'personnalise':
                            if (startDate && endDate) {
                                const start = new Date(startDate);
                                const end = new Date(endDate);
                                return offreDate >= start && offreDate <= end;
                            }
                            return true;
                        default:
                            return true;
                    }
                });
            }
            
            // Afficher les r√©sultats
            document.getElementById('filtered-count').innerHTML = 
                `<strong>${filteredOffres.length}</strong> offres trouv√©es`;
            
            document.getElementById('filtered-offres').innerHTML = 
                filteredOffres.map(offre => 
                    `<div>‚Ä¢ ${offre.intituleOffre} (${offre.dateDepot}) - ${offre.resultatOffre}</div>`
                ).join('');
        }

        function loadTestData() {
            testOffres = [...testOffresData];
            localStorage.setItem('offres', JSON.stringify(testOffres));
            localStorage.setItem('token', 'test-token');
            
            showMessage('‚úÖ Donn√©es de test charg√©es avec succ√®s !', 'success');
            displayStats();
            testPeriodFilter();
        }

        function clearData() {
            localStorage.removeItem('offres');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            testOffres = [];
            
            showMessage('üóëÔ∏è Donn√©es effac√©es', 'info');
            document.getElementById('stats-display').innerHTML = '';
            document.getElementById('filtered-count').innerHTML = '';
            document.getElementById('filtered-offres').innerHTML = '';
        }

        function showMessage(message, type) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.className = `test-section ${type}`;
            resultsDiv.innerHTML = `
                <h3>üìä R√©sultats du Test</h3>
                <div>${message}</div>
                <div id="stats-display"></div>
            `;
        }

        function displayStats() {
            const statsDisplay = document.getElementById('stats-display');
            
            if (testOffres.length === 0) return;
            
            const stats = {
                total: testOffres.length,
                gagnees: testOffres.filter(o => o.resultatOffre === 'Gagn√©e').length,
                perdues: testOffres.filter(o => o.resultatOffre === 'Perdue').length,
                enCours: testOffres.filter(o => o.resultatOffre === 'En cours').length
            };
            
            statsDisplay.innerHTML = `
                <h4>üìà Statistiques des Donn√©es de Test</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div>Total Offres</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.gagnees}</div>
                        <div>Gagn√©es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.perdues}</div>
                        <div>Perdues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.enCours}</div>
                        <div>En Cours</div>
                    </div>
                </div>
            `;
        }

        // Initialisation
        window.onload = function() {
            updatePermissionStatus();
            testPeriodFilter();
        };
    </script>
</body>
</html>
